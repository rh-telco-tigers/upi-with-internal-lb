# Configuration template for Keepalived, which is used to manage the DNS and
# API VIPs.
#
# For more information, see installer/data/data/bootstrap/baremetal/README.md
# in the installer repo.

global_defs {
    enable_script_security
    script_user root
}

vrrp_script chk_api {
    script "/usr/bin/timeout 1.9 /usr/bin/curl -o /dev/null -kLfs https://localhost:6443/readyz"
    interval 2
    weight 20
    rise 3
    fall 2
}

vrrp_instance {{.Cluster.Name}}_API {
    state BACKUP
    interface {{.VRRPInterface}}
    virtual_router_id {{.Cluster.APIVirtualRouterID }}
    priority 50
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass {{.Cluster.Name}}_api_vip
    }
    virtual_ipaddress {
        {{ .Cluster.APIVIP }}/{{ .Cluster.VIPNetmask }}
    }
    track_script {
        chk_api
    }
}
